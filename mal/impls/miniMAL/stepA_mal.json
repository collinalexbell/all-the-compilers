["do",

["load", ["`", "miniMAL-core.json"]],
["load", ["`", "types.json"]],
["load", ["`", "reader.json"]],
["load", ["`", "printer.json"]],
["load", ["`", "env.json"]],
["load", ["`", "core.json"]],

["def", "READ", ["fn", ["strng"], ["read-str", "strng"]]],

["def", "starts-with", ["fn", ["ast", "sym"],
  ["and", ["not", ["empty?", "ast"]],
          ["let", ["a0", ["first", "ast"]],
            ["and", ["symbol?", "a0"],
                    ["=", "sym", ["get", "a0", ["`", "val"]]]]]]]],

["def", "quasiquote-loop", ["fn", ["xs"],
  ["if", ["empty?", "xs"],
    ["list"],
    ["let", ["elt", ["first", "xs"],
             "acc", ["quasiquote-loop", ["rest", "xs"]]],
      ["if", ["and", ["list?", "elt"],
                     ["starts-with", "elt", ["`", "splice-unquote"]]],
        ["list", ["symbol", ["`", "concat"]], ["nth", "elt", 1], "acc"],
        ["list", ["symbol", ["`", "cons"]], ["quasiquote", "elt"], "acc"]]]]]],

["def", "quasiquote", ["fn", ["ast"],
  ["if", ["list?", "ast"],
    ["if", ["starts-with", "ast", ["`", "unquote"]],
      ["nth", "ast", 1],
      ["quasiquote-loop", "ast"]],
  ["if", ["vector?", "ast"],
    ["list", ["symbol", ["`", "vec"]], ["quasiquote-loop", "ast"]],
  ["if", ["or", ["map?", "ast"], ["symbol?", "ast"]],
    ["list", ["symbol", ["`", "quote"]], "ast"],
    "ast"]]]]],

["def", "macro?", ["fn", ["ast", "env"],
  ["and", ["list?", "ast"],
          ["symbol?", ["first", "ast"]],
          ["not", ["=", null, ["env-find", "env", ["first", "ast"]]]],
          ["let", ["fn", ["env-get", "env", ["first", "ast"]]],
            ["and", ["malfunc?", "fn"],
                    ["get", "fn", ["`", "macro?"]]]]]]],

["def", "macroexpand", ["fn", ["ast", "env"],
  ["if", ["macro?", "ast", "env"],
    ["let", ["mac", ["get", ["env-get", "env", ["first", "ast"]], ["`", "fn"]]],
      ["macroexpand", ["apply", "mac", ["rest", "ast"]], "env"]],
    "ast"]]],

["def", "eval-ast", ["fn", ["ast", "env"],
  ["if", ["symbol?", "ast"],
    ["env-get", "env", "ast"],
  ["if", ["list?", "ast"],
    ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"],
  ["if", ["vector?", "ast"],
    ["vectorl", ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"]],
  ["if", ["map?", "ast"],
    ["let", ["new-hm", ["hash-map"]],
      ["do",
        ["map", ["fn", ["k"], ["set", "new-hm",
                                ["EVAL", "k", "env"],
                                ["EVAL", ["get", "ast", "k"], "env"]]],
                ["keys", "ast"]],
        "new-hm"]],
  "ast"]]]]]],

["def", "LET", ["fn", ["env", "args"],
  ["if", [">", ["count", "args"], 0],
    ["do",
      ["env-set", "env", ["nth", "args", 0],
                         ["EVAL", ["nth", "args", 1], "env"]],
      ["LET", "env", ["rest", ["rest", "args"]]]]]]],

["def", "EVAL", ["fn", ["ast", "env"],
  ["if", ["not", ["list?", "ast"]],
    ["eval-ast", "ast", "env"],
    ["let", ["ast", ["macroexpand", "ast", "env"]],
      ["if", ["not", ["list?", "ast"]],
        ["eval-ast", "ast", "env"],
        ["if", ["empty?", "ast"],
          "ast",
          ["let", ["a0", ["get", ["first", "ast"], ["`", "val"]]],
            ["if", ["=", ["`", "def!"], "a0"],
              ["env-set", "env", ["nth", "ast", 1],
                                 ["EVAL", ["nth", "ast", 2], "env"]],
            ["if", ["=", ["`", "let*"], "a0"],
              ["let", ["let-env", ["env-new", "env"]],
                ["do",
                  ["LET", "let-env", ["nth", "ast", 1]],
                  ["EVAL", ["nth", "ast", 2], "let-env"]]],
            ["if", ["=", ["`", "quote"], "a0"],
              ["nth", "ast", 1],
            ["if", ["=", ["`", "quasiquoteexpand"], "a0"],
              ["quasiquote", ["nth", "ast", 1]],
            ["if", ["=", ["`", "quasiquote"], "a0"],
              ["EVAL", ["quasiquote", ["nth", "ast", 1]], "env"],
            ["if", ["=", ["`", "defmacro!"], "a0"],
              ["let", ["func", ["EVAL", ["nth", "ast", 2], "env"]],
                ["do",
                  ["set", "func", ["`", "macro?"], true],
                  ["env-set", "env", ["nth", "ast", 1], "func"]]],
            ["if", ["=", ["`", "macroexpand"], "a0"],
              ["macroexpand", ["nth", "ast", 1], "env"],
            ["if", ["=", ["`", "try*"], "a0"],
              ["if", ["and", [">", ["count", "ast"], 2],
                             ["=", ["`", "catch*"],
                                   ["get", ["nth", ["nth", "ast", 2], 0],
                                           ["`", "val"]]]],
                ["try",
                  ["EVAL", ["nth", "ast", 1], "env"],
                  ["catch", "exc",
                    ["EVAL", ["nth", ["nth", "ast", 2], 2],
                             ["env-new", "env",
                                         ["list", ["nth", ["nth", "ast", 2], 1]],
                                         ["list", "exc"]]]]],
                ["EVAL", ["nth", "ast", 1], "env"]],
            ["if", ["=", ["`", "do"], "a0"],
              ["do",
                ["eval-ast", ["slice", "ast", 1, ["-", ["count", "ast"], 1]], "env"],
                ["EVAL", ["nth", "ast", ["-", ["count", "ast"], 1]], "env"]],
            ["if", ["=", ["`", "if"], "a0"],
              ["let", ["cond", ["EVAL", ["nth", "ast", 1], "env"]],
                ["if", ["or", ["=", "cond", null], ["=", "cond", false]],
                  ["if", [">", ["count", "ast"], 3],
                    ["EVAL", ["nth", "ast", 3], "env"],
                    null],
                  ["EVAL", ["nth", "ast", 2], "env"]]],
            ["if", ["=", ["`", "fn*"], "a0"],
              ["malfunc",
                ["fn", ["&", "args"],
                  ["let", ["e", ["env-new", "env", ["nth", "ast", 1], "args"]],
                    ["EVAL", ["nth", "ast", 2], "e"]]],
                ["nth", "ast", 2], "env", ["nth", "ast", 1]],
              ["let", ["el", ["eval-ast", "ast", "env"],
                       "f", ["first", "el"],
                       "args", ["rest", "el"]],
                ["if", ["malfunc?", "f"],
                  ["EVAL", ["get", "f", ["`", "ast"]],
                           ["env-new", ["get", "f", ["`", "env"]],
                                       ["get", "f", ["`", "params"]],
                                       "args"]],
                  ["apply", "f", "args"]]]]]]]]]]]]]]]]]]]]],

["def", "PRINT", ["fn", ["exp"],
  ["pr-str", "exp", true]]],


["def", "repl-env", ["env-new"]],

["def", "rep", ["fn", ["strng"],
  ["try",
    ["PRINT", ["EVAL", ["READ", "strng"], "repl-env"]],
    ["catch", "exc",
      ["str", ["`", "Error: "],
        ["if", ["isa", "exc", "Error"],
          [".", "exc", ["`", "toString"]],
          ["pr-str", "exc", true]]]]]]],

["`", "core.mal: defined using miniMAL"],
["map", ["fn", ["k"], ["env-set", "repl-env",
                                  ["symbol", "k"],
                                  ["get", "core-ns", "k"]]],
        ["keys", "core-ns"]],
["env-set", "repl-env", ["symbol", ["`", "eval"]],
                        ["fn", ["ast"], ["EVAL", "ast", "repl-env"]]],
["env-set", "repl-env", ["symbol", ["`", "*ARGV*"]],
                        ["slice", "ARGS", 1]],

["`", "core.mal: defined using mal itself"],
["rep", ["`", "(def! *host-language* \"miniMAL\")"]],
["rep", ["`", "(def! not (fn* (a) (if a false true)))"]],
["rep", ["`", "(def! load-file (fn* (f) (eval (read-string (str \"(do \" (slurp f) \"\nnil)\")))))"]],
["rep", ["`", "(defmacro! cond (fn* (& xs) (if (> (count xs) 0) (list 'if (first xs) (if (> (count xs) 1) (nth xs 1) (throw \"odd number of forms to cond\")) (cons 'cond (rest (rest xs)))))))"]],

["if", ["not", ["empty?", "ARGS"]],
  ["rep", ["str", ["`", "(load-file \""], ["get", "ARGS", 0], ["`", "\")"]]],
  ["do",
    ["rep", ["`", "(println (str \"Mal [\" *host-language* \"]\"))"]],
    ["repl", ["`", "user> "], "rep"]]],

null

]
